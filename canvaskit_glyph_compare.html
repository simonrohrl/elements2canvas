<!DOCTYPE html>
<html>
<head>
  <title>CanvasKit Glyph ID Comparison</title>
  <script src="https://unpkg.com/canvaskit-wasm@0.39.1/bin/canvaskit.js"></script>
</head>
<body>
  <h2>Glyph ID Comparison: Chromium vs CanvasKit</h2>
  <pre id="log"></pre>

<script type="module">
const log = (msg) => {
    document.getElementById('log').textContent += msg + '\n';
    console.log(msg);
};

async function main() {
    log('Loading CanvasKit...');

    const CanvasKit = await CanvasKitInit({
        locateFile: (file) => `https://unpkg.com/canvaskit-wasm@0.39.1/bin/${file}`,
    });

    log('CanvasKit loaded\n');

    // Load font
    const fontResp = await fetch("Arial.ttf");
    const fontData = await fontResp.arrayBuffer();
    const typeface = CanvasKit.Typeface.MakeFreeTypeFaceFromData(fontData);
    if (!typeface) {
        log('ERROR: Failed to load font');
        return;
    }
    log('Font loaded: Arial.ttf\n');

    const font = new CanvasKit.Font(typeface, 48);

    // The text we expect: "Gradient Fill Text"
    const text = "Gradient Fill Text";

    // Glyph IDs from Chromium's raw_paint_ops.json
    const chromiumGlyphs = [
        42, 85, 68, 71, 76, 72, 81, 87, 3, 41, 76, 79, 79, 3, 55, 72, 91, 87
    ];

    // Get glyph IDs from CanvasKit for the same text
    const canvaskitGlyphs = font.getGlyphIDs(text);

    log('=== GLYPH ID COMPARISON ===\n');
    log(`Text: "${text}" (${text.length} characters)\n`);

    log('Chromium glyph IDs:');
    log(`  [${chromiumGlyphs.join(', ')}]`);
    log(`  Count: ${chromiumGlyphs.length}\n`);

    log('CanvasKit glyph IDs:');
    log(`  [${Array.from(canvaskitGlyphs).join(', ')}]`);
    log(`  Count: ${canvaskitGlyphs.length}\n`);

    // Compare
    let match = chromiumGlyphs.length === canvaskitGlyphs.length;
    if (match) {
        for (let i = 0; i < chromiumGlyphs.length; i++) {
            if (chromiumGlyphs[i] !== canvaskitGlyphs[i]) {
                match = false;
                break;
            }
        }
    }

    log('=== RESULT ===');
    if (match) {
        log('MATCH: Chromium and CanvasKit produce identical glyph IDs');
    } else {
        log('MISMATCH: Glyph IDs differ between Chromium and CanvasKit!');
        log('This could cause rendering issues when using Chromium glyph IDs directly.');
        log('\nDifferences:');
        const maxLen = Math.max(chromiumGlyphs.length, canvaskitGlyphs.length);
        for (let i = 0; i < maxLen; i++) {
            const cg = chromiumGlyphs[i] ?? 'N/A';
            const kg = canvaskitGlyphs[i] ?? 'N/A';
            const char = text[i] || '';
            const diffMark = cg === kg ? '' : ' <-- DIFF';
            log(`  [${i}] char='${char}' chromium=${cg} canvaskit=${kg}${diffMark}`);
        }
    }

    // Also check character to glyph mapping
    log('\n=== CHARACTER TO GLYPH MAPPING (CanvasKit) ===');
    for (let i = 0; i < text.length; i++) {
        const char = text[i];
        const glyphId = canvaskitGlyphs[i];
        log(`  '${char}' (U+${char.charCodeAt(0).toString(16).padStart(4, '0')}) -> glyph ${glyphId}`);
    }

    font.delete();
}

main();
</script>
</body>
</html>
